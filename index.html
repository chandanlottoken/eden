<!DOCTYPE HTML>
<html>

<head>
  <title>Eden Protection for your Crypto Assets</title>
</head>
<script src="https://rawgit.com/ethereum/web3.js/0.16.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethjs@0.3.0/dist/ethjs.min.js"></script>
<script src="keythereum.min.js" type="text/javascript"></script>
<script src="sjcl.js"></script>
<body>
    <div>
    Phone Number <input id="phone"> 
    <br>
    <br>
    Email Address<input id="email"> 
    <br>
    <button id="secure">Secure My Assets</button>
    <button id="recover">Recover My Assets</button>
    </div>

    <div id="secureacctsection" style="display:none">
    <hr>

    <div id="keygen" style="display:none">
    <b>Generating your recovery keys......</b>
    </div>
    <div id="questionblock" style="display:none">
    <b> Answer atleast 7 questions. </b>
    <br>
    If not relevant, leave answers to the following questions empty.
    <br>
    <br>
    1. What is the first name of your spouse's father?<input id="q1">
    <br>
    2. What was your High School Mascot?  <input id="q2">
    <br>
    3. In what city or town did you meet your spouse/partner?  <input id="q3">
    <br>
    4. In what city or town did your mother and father meet?  <input id="q4">
    <br>
    5. In what town or city was your first full time job?  <input id="q5">
    <br>
    6. What is the make of your first car?  <input id="q6">
    <br>
    7. What is the name of your first pet?  <input id="q7">
    <br>
    8. What is the name of your first school? <input id="q8">
    <br>
    9. What is your oldest child's nickname? <input id="q9">
    <br>
    10. What is the name of the place your wedding reception was held? <input id="q10">
    <br>
    11. What is the name of your favorite childhood friend? <input id="q11">
    <br>
    12. What school did you attend for sixth grade? <input id="q12">
    <br>
    13. What time of the day was your first child born? (hh:mm) <input id="q13">
    <br>
    14. What time of the day were you born? (hh:mm) <input id="q14">
    <br>
    15. What was the house number and street name you lived in as a child? <input id="q15">
    <br>
    16. What was the last name of your third grade teacher? <input id="q16">
    <br>
    17. What was the make and model of your first car? <input id="q17">
    <br>
    18. What was the name of the company where you had your first job? <input id="q18">
    <br>
    19. What was the name of the hospital where you were born? <input id="q19">
    <br>
    20. What was the name of your elementary / primary school? <input id="q20">
    <br>
    21. What was the name of your first stuffed animal or doll or action figure? <input id="q21">
    <br>
    22. What was your childhood nickname? <input id="q22">
    <br>
    23. What was your favorite food as a child? <input id="q23">
    <br>
    24. What was your favorite place to visit as a child? <input id="q24">
    <br>
    25. What was your favorite sport in high school? <input id="q25">
    <br>
    26. What were the last four digits of your childhood telephone number? <input id="q26">
    <br>
    27. Where were you New Year's 2000? <input id="q27">
    <br>
    28. Who is your childhood sports hero? <input id="q28">
    <br>
    29. Who was your childhood hero? <input id="q29">
    <br>
    30. What is your youngest child's nickname? <input id="q30">
    <br>
    <br>
    <button id="encrypt">Done Answering</button>
    </div>

    <button id="start" style="display:none">Internet Turned Off (Generate My Recovery Keys)</button>

    </div>  
 
<script>
// Global key variables FOR RECOVERY ACCOUNT
var privateKey = "";
var keyAddress = "";
var keyBlub = "";
var email = "";
var phone = "";
var originalAddress = ""; // original wallet address which was secured

function encrypt() {
    var q1 = document.getElementById('q1').value.trim().toLowerCase();
    var q2 = document.getElementById('q2').value.trim().toLowerCase();
    var q3 = document.getElementById('q3').value.trim().toLowerCase();
    var q4 = document.getElementById('q4').value.trim().toLowerCase();
    var q5 = document.getElementById('q5').value.trim().toLowerCase();
    var q6 = document.getElementById('q6').value.trim().toLowerCase();
    var q7 = document.getElementById('q7').value.trim().toLowerCase();
    var q8 = document.getElementById('q8').value.trim().toLowerCase();
    var q9 = document.getElementById('q9').value.trim().toLowerCase();
    var q10 = document.getElementById('q10').value.trim().toLowerCase();
    var q11 = document.getElementById('q11').value.trim().toLowerCase();
    var q12 = document.getElementById('q12').value.trim().toLowerCase();
    var q13 = document.getElementById('q13').value.trim().toLowerCase();
    var q14 = document.getElementById('q14').value.trim().toLowerCase();
    var q15 = document.getElementById('q15').value.trim().toLowerCase();
    var q16 = document.getElementById('q16').value.trim().toLowerCase();
    var q17 = document.getElementById('q17').value.trim().toLowerCase();
    var q18 = document.getElementById('q18').value.trim().toLowerCase();
    var q19 = document.getElementById('q19').value.trim().toLowerCase();
    var q20 = document.getElementById('q20').value.trim().toLowerCase();
    var q21 = document.getElementById('q21').value.trim().toLowerCase();
    var q22 = document.getElementById('q22').value.trim().toLowerCase();
    var q23 = document.getElementById('q23').value.trim().toLowerCase();
    var q24 = document.getElementById('q24').value.trim().toLowerCase();
    var q25 = document.getElementById('q25').value.trim().toLowerCase();
    var q26 = document.getElementById('q26').value.trim().toLowerCase();
    var q27 = document.getElementById('q27').value.trim().toLowerCase();
    var q28 = document.getElementById('q28').value.trim().toLowerCase();
    var q29 = document.getElementById('q29').value.trim().toLowerCase();
    var q30 = document.getElementById('q30').value.trim().toLowerCase();

    var encryptionkey = 
        q1 + q2 + q3 + q4 + q5 + q6 + q7 + q8 + q9 + q10 +
        q11 + q12 + q13 + q14 + q15 + q16 + q17 + q18 + q19 + q20 +
        q21 + q22 + q23 + q24 + q25 + q26 + q27 + q28 + q29 + q30;

    var data = { qsource : "QmNY5oxKAzZwf6UswT1h3WWwWqMw58S2Qtdbjz2QVPmqEY"};
    data.qlist = [];
    if (!!q1) data.qlist.push(1);
    if (!!q2) data.qlist.push(2);
    if (!!q3) data.qlist.push(3);
    if (!!q4) data.qlist.push(4);
    if (!!q5) data.qlist.push(5);
    if (!!q6) data.qlist.push(6);
    if (!!q7) data.qlist.push(7);
    if (!!q8) data.qlist.push(8);
    if (!!q9) data.qlist.push(9);
    if (!!q10) data.qlist.push(10);
    if (!!q11) data.qlist.push(11);
    if (!!q12) data.qlist.push(12);
    if (!!q13) data.qlist.push(13);
    if (!!q14) data.qlist.push(14);
    if (!!q15) data.qlist.push(15);
    if (!!q16) data.qlist.push(16);
    if (!!q17) data.qlist.push(17);
    if (!!q18) data.qlist.push(18);
    if (!!q19) data.qlist.push(19);
    if (!!q20) data.qlist.push(20);
    if (!!q21) data.qlist.push(21);
    if (!!q22) data.qlist.push(22);
    if (!!q23) data.qlist.push(23);
    if (!!q24) data.qlist.push(24);
    if (!!q25) data.qlist.push(25);
    if (!!q26) data.qlist.push(26);
    if (!!q27) data.qlist.push(27);
    if (!!q28) data.qlist.push(28);
    if (!!q29) data.qlist.push(29);
    if (!!q30) data.qlist.push(30);

    if (data.qlist.length < 7) {
        alert("Answer atleast 7 security questions.");
        return;
    }

    var encrypteddata = sjcl.encrypt(encryptionkey, privateKey);
    data.datatype = "privatekey";
    data.encrypteddata = encrypteddata;
    var b64encrypteddata = keyAddress + window.btoa(JSON.stringify(data));

    alert ("FYI: Following recovery key string encrypted blub will be used in the Eden Smart Contract:\n\n"+ b64encrypteddata);
    keyBlub = b64encrypteddata;
    keyAddress = "0x" + keyAddress;

    // make sure rest of q & a block is no longer displayed
    document.getElementById('secureacctsection').style.display = 'none';

    // now actually secure the account by interacting with Eden Smart Contract
    add_to_contract();
}

//==== Start Code which interacts with MetaMask and the Eden Smart Contract ====
window.addEventListener('load', function() {
    // Check if Web3 has been injected by the browser:
    if (typeof web3 !== 'undefined') {
        // You have a web3 browser! Continue below!
        startApp(web3);
        //alert("Web3");
    } else {
        //alert("No hay web3");
        // Warn the user that they need to get a web3 browser
        // Or install MetaMask, maybe with a nice graphic.
    }
})
    
const promisify = (inner) =>
    new Promise((resolve, reject) =>
        inner((err, res) => {
            if (err) {
                reject(err);
            } else {
                resolve(res);
            }
        })
    );
    
const abi = [
    {
      "constant": true,
      "inputs": [
        {
          "name": "email",
          "type": "bytes32"
        }
      ],
      "name": "get_original_wallet_address_by_email",
      "outputs": [
        {
          "name": "",
          "type": "address"
        }
      ],
      "payable": false,
      "type": "function"
    },
    {
      "constant": true,
      "inputs": [
        {
          "name": "token",
          "type": "address"
        },
        {
          "name": "account",
          "type": "address"
        },
        {
          "name": "spender",
          "type": "address"
        }
      ],
      "name": "remove_me_show_allowance",
      "outputs": [
        {
          "name": "",
          "type": "uint256"
        }
      ],
      "payable": false,
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "take",
          "type": "uint256"
        }
      ],
      "name": "remove_some_ether",
      "outputs": [],
      "payable": false,
      "type": "function"
    },
    {
      "constant": true,
      "inputs": [
        {
          "name": "account_address",
          "type": "address"
        }
      ],
      "name": "get_recovery_key_info_by_original_address",
      "outputs": [
        {
          "name": "",
          "type": "string"
        }
      ],
      "payable": false,
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "account_owner",
          "type": "address"
        }
      ],
      "name": "cancel_veto_for_account",
      "outputs": [],
      "payable": false,
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "account_address",
          "type": "address"
        }
      ],
      "name": "recover_account_begin",
      "outputs": [
        {
          "name": "key_info",
          "type": "string"
        }
      ],
      "payable": false,
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "input_recovery_account",
          "type": "address"
        },
        {
          "name": "input_phone_number_of_account_owner",
          "type": "bytes32"
        },
        {
          "name": "input_email_id_of_account_owner",
          "type": "bytes32"
        },
        {
          "name": "input_key_info",
          "type": "string"
        },
        {
          "name": "input_timeout",
          "type": "uint256"
        },
        {
          "name": "input_veto_address",
          "type": "address"
        }
      ],
      "name": "secure_account_big",
      "outputs": [],
      "payable": true,
      "type": "function"
    },
    {
      "constant": true,
      "inputs": [
        {
          "name": "email",
          "type": "bytes32"
        }
      ],
      "name": "get_recovery_key_info_by_email",
      "outputs": [
        {
          "name": "",
          "type": "string"
        }
      ],
      "payable": false,
      "type": "function"
    },
    {
      "constant": true,
      "inputs": [
        {
          "name": "account_address",
          "type": "address"
        }
      ],
      "name": "get_recovery_address_by_original_address",
      "outputs": [
        {
          "name": "",
          "type": "address"
        }
      ],
      "payable": false,
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "input_recovery_account",
          "type": "address"
        },
        {
          "name": "input_key_info",
          "type": "string"
        }
      ],
      "name": "secure_account",
      "outputs": [],
      "payable": true,
      "type": "function"
    },
    {
      "constant": true,
      "inputs": [
        {
          "name": "phone",
          "type": "bytes32"
        }
      ],
      "name": "get_original_wallet_address_by_phone",
      "outputs": [
        {
          "name": "",
          "type": "address"
        }
      ],
      "payable": false,
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [],
      "name": "set_veto_for_account",
      "outputs": [],
      "payable": false,
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "account_address",
          "type": "address"
        }
      ],
      "name": "recover_account_end_ether",
      "outputs": [
        {
          "name": "key_info",
          "type": "string"
        }
      ],
      "payable": false,
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "account_address",
          "type": "address"
        }
      ],
      "name": "cancel_account_call_after_recover",
      "outputs": [],
      "payable": false,
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [],
      "name": "cancel_account",
      "outputs": [],
      "payable": false,
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "account_address",
          "type": "address"
        },
        {
          "name": "token",
          "type": "address"
        }
      ],
      "name": "recover_account_end_tokens",
      "outputs": [
        {
          "name": "key_info",
          "type": "string"
        }
      ],
      "payable": false,
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "input_phone_number_of_account_owner",
          "type": "bytes32"
        }
      ],
      "name": "add_phone_number",
      "outputs": [],
      "payable": false,
      "type": "function"
    },
    {
      "constant": true,
      "inputs": [
        {
          "name": "phone",
          "type": "bytes32"
        }
      ],
      "name": "get_recovery_key_info_by_phone",
      "outputs": [
        {
          "name": "",
          "type": "string"
        }
      ],
      "payable": false,
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "input_veto_address",
          "type": "address"
        }
      ],
      "name": "add_veto_addr",
      "outputs": [],
      "payable": false,
      "type": "function"
    },
    {
      "constant": false,
      "inputs": [
        {
          "name": "input_email_id_of_account_owner",
          "type": "bytes32"
        }
      ],
      "name": "add_email_addr",
      "outputs": [],
      "payable": false,
      "type": "function"
    },
    {
      "payable": true,
      "type": "fallback"
    }
  ]
  
const contract_address = '0x8C381b4200c7bFC66523df6df6C3D162602a7B5d'
const etherValue = web3.toWei(10, 'ether');
var address = '0x91612055A68aD74A6e756615941Ac59e9220A940'
var balzoo = ''
var temp_token_address = ''
function startApp(web3) {
    //alert("entro");
    const eth = new Eth(web3.currentProvider)
    const token = eth.contract(abi).at(contract_address);
    listenForClicks(token,web3)
    //alert("llego");
}
//function sleep(ms) {
//  return new Promise(resolve => setTimeout(resolve, ms));
//}
async function getBalance5(addr) {
    var wei, balance
    wei = promisify(cb => web3.eth.getBalance(addr, cb))
    try {
        balzoo = web3.fromWei(await wei, 'wei') - 90000000000000000;
        if(balzoo < 0) balzoo = 0;
        
    } catch (error) {
        
    }
}

var secure_account_event = new CustomEvent("secure_account");
var secure_account_big_event = new CustomEvent("secure_account_big");
var recover_account_end_ether_event = new CustomEvent("recover_account_end_ether");
var recover_account_begin_event = new CustomEvent("recover_account_begin");
var recover_account_end_tokens_event = new CustomEvent("recover_account_end_tokens");
var get_recovery_address_by_original_address_event = new CustomEvent("get_recovery_address_by_original_address");
var get_recovery_key_info_by_phone_event = new CustomEvent("get_recovery_key_info_by_phone");
var get_recovery_key_info_by_original_address_event = new CustomEvent("get_recovery_key_info_by_original_address");
var get_recovery_key_info_by_email_event = new CustomEvent("get_recovery_key_info_by_email");
var get_original_wallet_address_by_email_event = new CustomEvent("get_original_wallet_address_by_email");
var add_email_addr_event = new CustomEvent("add_email_addr");
var get_original_wallet_address_by_phone_event = new CustomEvent("get_original_wallet_address_by_phone");
var add_phone_number_event = new CustomEvent("add_phone_number");
var cancel_account_event = new CustomEvent("cancel_account");

function listenForClicks (miniToken, web3) {
    
    var balb, adjb
    web3.eth.getAccounts(function(err, accounts) { console.log(accounts); address = accounts.toString(); })
 
    document.body.addEventListener('secure_account_big', function() {
        getBalance5(address)
          .then (function () { miniToken.secure_account_big(keyAddress, 
                       web3.toHex(phone) + Array(67 - web3.toHex(phone).length).join('0'),
                       web3.toHex(email) + Array(67 - web3.toHex(phone).length).join('0'),
                       keyBlub, 1, keyAddress, { from: address, value: balzoo, gas: 1000000 }) 
            .then(function (txHash) {
            console.log('Transaction sent')
            console.dir(txHash)
            waitForTxToBeMined(txHash)
        }) .catch(console.error);
        }) .catch(console.error);

        // send some gas ether to recovery account 
            eth.sendTransaction( {from: address, value: 10000000000000000, to:keyAddress, data:{}}).then(function(txHash) {
            console.log('Ether Transaction sent for gas')
            console.dir(txHash)
            waitForTxToBeMined(txHash)
        }).catch(console.error);
         
    }) 
 
    document.body.addEventListener('secure_account', function() {
        getBalance5(address)
          .then (function () { miniToken.secure_account(keyAddress, keyBlub, { from: address, value: balzoo, gas: 1000000 }) 
            .then(function (txHash) {
            console.log('Ether Transaction sent to smart contract')
            console.dir(txHash)
            waitForTxToBeMined(txHash)
        }) .catch(console.error);
        }) .catch(console.error);

        // send some gas ether to recovery account 
            eth.sendTransaction( {from: address, value: 10000000000000000, to:keyAddress, data:{}}).then(function(txHash) {
            console.log('Ether Transaction sent for gas')
            console.dir(txHash)
            waitForTxToBeMined(txHash)
        }).catch(console.error);
         
    }) 
 
    document.body.addEventListener('recover_account_end_ether', function() {
    miniToken.recover_account_end_ether(originalAddress, { from: address, gas: 300000 }).then(function (txHash) {
            console.log('Transaction sent')
            console.dir(txHash)
            waitForTxToBeMined(txHash)
        }) .catch(console.error);
  })
  
    document.body.addEventListener('recover_account_begin',  function() {
    miniToken.recover_account_begin(originalAddress, { from: address, gas: 300000 }).then(function (txHash) {
            console.log('Transaction sent')
            console.dir(txHash)
            waitForTxToBeMined(txHash)
        }) .catch(console.error);
      
  })
  
    document.body.addEventListener('recover_account_end_tokens', function() {
      temp_token_address = document.getElementById('get_token_address5').value.trim().toLowerCase(); // TBD to be fixed
    miniToken.recover_account_end_tokens(originalAddress, temp_token_address, { from: address, gas: 300000 }).then(function (txHash) {
            console.log('Transaction sent')
            console.dir(txHash)
            waitForTxToBeMined(txHash)
        }) .catch(console.error);
      
  })
  
  
    document.body.addEventListener('get_recovery_address_by_original_address', function() {
        miniToken.get_recovery_address_by_original_address(originalAddress).then (function (a) { console.log(a);})
  })
  
  document.body.addEventListener('get_recovery_key_info_by_phone', function() {
      miniToken.get_recovery_key_info_by_phone(web3.toHex(phone) + Array(67 - web3.toHex(phone).length).join('0')).then (function (a) { console.log(a);})
    
    
  })
  
  document.body.addEventListener('get_recovery_key_info_by_original_address', function() {
      miniToken.get_recovery_key_info_by_original_address(originalAddress).then (function (a) { console.log(a);})
  })
  
  document.body.addEventListener('get_recovery_key_info_by_email', function() {
      miniToken.get_recovery_key_info_by_email(web3.toHex(email) + Array(67 - web3.toHex(email).length).join('0')).then (function (a) { console.log(a);})
    
    
  })
  
   document.body.addEventListener('get_original_wallet_address_by_email', function() {
     miniToken.get_original_wallet_address_by_email(web3.toHex(email) + Array(67 - web3.toHex(email).length).join('0')).then (function (a) { console.log(a);})
    }) 
  
   document.body.addEventListener('add_email_addr', function() {
      miniToken.add_email_addr(web3.toHex(email) + Array(67 - web3.toHex(email).length).join('0'), { from: address, gas: 300000 }).then(function (txHash) {
            console.log('Transaction sent')
            console.dir(txHash)
            waitForTxToBeMined(txHash)
        }) .catch(console.error);
    }) 
  
  
    document.body.addEventListener('get_original_wallet_address_by_phone', function() {
     miniToken.get_original_wallet_address_by_phone(web3.toHex(phone) + Array(67 - web3.toHex(phone).length).join('0')).then (function (a) { console.log(a);})
    }) 
  
   document.body.addEventListener('add_phone_number', function() {
      miniToken.add_phone_number(web3.toHex(phone) + Array(67 - web3.toHex(phone).length).join('0'),{ from: address, gas: 300000 }).then(function (txHash) {
            console.log('Transaction sent')
            console.dir(txHash)
            waitForTxToBeMined(txHash)
        }) .catch(console.error);
    }) 
  
    document.body.addEventListener('cancel_account', function() {
      miniToken.cancel_account({ from: address, gas: 300000 }).then(function (txHash) {
            console.log('Transaction sent')
            console.dir(txHash)
            waitForTxToBeMined(txHash)
        }) .catch(console.error);
    }) 
  
}
    
async function waitForTxToBeMined (txHash) {
    let txReceipt
    while (!txReceipt) {
        try {
            txReceipt = await eth.getTransactionReceipt(txHash)
        } catch (err) {
            return err
        }
    }
    indicateSuccess()
}

function add_to_contract()
{
    document.body.dispatchEvent(secure_account_big_event);
}
//==== End Code which interacts with MetaMask and the Eden Smart Contract ====


function start_secure_account() {
    var isChrome = !!window.chrome && !!window.chrome.webstore;
    if (!isChrome)
    {
        alert('Only supported on google chrome.');
        window.close();
        return;
    } 
   
    email = document.getElementById('email').value.trim().toLowerCase();
    phone = document.getElementById('phone').value.trim().toLowerCase();
    if (!email)
    {
        alert("Please enter email.");
        return;
    }
    if (!phone)
    {
        alert("Please enter phone.");
        return;
    }

    // make secure account stuff is displayed now 
    document.getElementById('secureacctsection').style.display = 'block';

    // start google chrome code
    if(navigator.onLine){
        alert('We need to generate your recovery keys.\n\nTURN OFF YOUR INTERNET CONNECTION (turn off wifi or disconnect LAN).');
    } 
    document.getElementById('start').style.display = 'block';
    document.getElementById('start').addEventListener('click', start);
}

function start() {
    document.getElementById('start').style.display = 'none';
    document.getElementById('keygen').style.display = 'block';

    if(navigator.onLine){
        alert('Internet is still on. You will be at risk.');
    }

    // synchronous recovery key generation
    var dk = keythereum.create();
    // alert(JSON.stringify(dk));
    privateKey = dk.privateKey.toString('hex');
    keythereum.dump("", dk.privateKey, dk.salt, dk.iv,{},function (keyObject){
    keyAddress = keyObject.address;
    alert ("Following recovery ethereum address has been generated.\nYou do not need to copy this. Just FYI.\n\nPrivate Key:" + privateKey + "\n\nAddress: 0x" + keyAddress + "\n");
    document.getElementById('keygen').style.display = 'none';
    document.getElementById('questionblock').style.display = 'block';
    });
    document.getElementById('encrypt').addEventListener('click', encrypt);
}

function recover() {
    // make sure other stuff is not displayed
    document.getElementById('secureacctsection').style.display = 'none';

    var isChrome = !!window.chrome && !!window.chrome.webstore;
    if (!isChrome)
    {
        alert('Only supported on google chrome.');
        window.close();
        return;
    } 
   
    email = document.getElementById('email').value.trim().toLowerCase();
    phone = document.getElementById('phone').value.trim().toLowerCase();
    if ((!email) && (!phone))
    {
        alert("Please enter either email or phone.");
        return;
    }


    alert("Recover functionality not implemented yet");
}

document.getElementById('secure').addEventListener('click', start_secure_account);
document.getElementById('recover').addEventListener('click', recover);


</script>
</body>

</html>
